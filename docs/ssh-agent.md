# rosec SSH Agent

`rosecd` includes a built-in SSH agent and a FUSE virtual filesystem that expose SSH keys from your unlocked vault — without ever writing private key material to disk.

## Overview

When `rosecd` starts, it:

1. Binds an SSH agent socket at `$XDG_RUNTIME_DIR/rosec/agent.sock`
2. Mounts a FUSE filesystem at `$XDG_RUNTIME_DIR/rosec/ssh/`

The FUSE filesystem is read-only and entirely in-memory.  Its contents update automatically when the vault is re-synced or a backend is locked/unlocked.  No private keys are ever written to disk.

## FUSE Filesystem Layout

```
$XDG_RUNTIME_DIR/rosec/ssh/
├── keys/
│   ├── by-name/                        # keyed by vault item name
│   │   ├── My GitHub Key.pub
│   │   └── Production Server.pub
│   ├── by-fingerprint/                 # keyed by SHA-256 fingerprint
│   │   ├── SHA256_xxxxxxxxxxxxxx.pub
│   │   └── SHA256_yyyyyyyyyyyyyy.pub
│   └── by-host/                        # keyed by mapped hostname
│       ├── github.com.pub
│       ├── _star.prod.example.com.pub  # * replaced with _star
│       └── bastion.internal.pub
└── config.d/                           # SSH config snippets
    ├── my_github_key.conf
    └── production_server.conf
```

All `.pub` files contain the OpenSSH wire-format public key (the same line you would put in `~/.ssh/authorized_keys`).

## SSH Key Sources

rosec discovers SSH keys from any vault item regardless of type.  Two sources are supported:

### Native SSH Key items (type `sshkey`)

Vault backends that have a first-class SSH key type (e.g. Bitwarden's native SSH Key item) expose the key directly.  rosec uses the `private_key` field for signing and derives the public key automatically.

### PEM keys in notes, passwords, or hidden custom fields

rosec scans the `notes`, `password`, and hidden `custom.*` fields of **all** vault items for PEM-encoded private keys.  The following headers are recognised:

```
-----BEGIN OPENSSH PRIVATE KEY-----
-----BEGIN PRIVATE KEY-----
-----BEGIN RSA PRIVATE KEY-----
-----BEGIN EC PRIVATE KEY-----
-----BEGIN DSA PRIVATE KEY-----
-----BEGIN ENCRYPTED PRIVATE KEY-----
```

This means you can store SSH keys as a Secure Note or as a hidden custom field on a Login item and they will be discovered automatically — no special item type required.

## Host Mapping with `ssh_host`

The most powerful feature of the rosec SSH agent is automatic SSH config generation based on vault item fields.

### How it works

Add one or more **text custom fields** named `ssh_host` (or `ssh-host`) to any vault item that contains an SSH key.  Each field value is an OpenSSH `Host` pattern:

| Field name | Field value | Effect |
|---|---|---|
| `ssh_host` | `github.com` | Maps this key to `github.com` |
| `ssh_host` | `*.prod.example.com` | Maps this key to all prod hosts |
| `ssh_host` | `bastion.internal` | Maps this key to the bastion |

Multiple `ssh_host` fields on the same item are all honoured — each generates its own `Host` block in the config snippet.

A single field can also contain **newline-separated** host patterns, which is equivalent to multiple fields:

```
github.com
*.prod.example.com
bastion.internal
```

### Setting the SSH user with `ssh_user`

Add a text custom field named `ssh_user` (or `ssh-user`) to set the `User` directive in the generated `Host` blocks:

| Field name | Field value | Effect |
|---|---|---|
| `ssh_user` | `deploy` | Adds `User deploy` to each Host block |

Only the first `ssh_user` field is used if multiple are present.

### Generated config snippets

For each vault item that has at least one `ssh_host` field, rosec generates a `.conf` file in `config.d/`.  The filename is derived from the item name using the following normalisation rules:

- Converted to lowercase
- Spaces and punctuation replaced with `_`
- Leading `.` replaced with `_dot`
- `*` replaced with `_star`

Example: `"My Server One.two"` → `my_server_one_two.conf`

A generated snippet looks like:

```
# Auto-generated by rosec — do not edit
# Source: My GitHub Key (last updated: 2025-12-01T10:30:00Z)

Host github.com
    User git
    IdentityFile /run/user/1000/rosec/ssh/keys/by-name/My GitHub Key.pub
    IdentityAgent /run/user/1000/rosec/agent.sock
    IdentitiesOnly yes

Host gh-alt.example.com
    User git
    IdentityFile /run/user/1000/rosec/ssh/keys/by-name/My GitHub Key.pub
    IdentityAgent /run/user/1000/rosec/agent.sock
    IdentitiesOnly yes
```

- `User` is only emitted when the vault item has a `ssh_user` custom field.
- `IdentitiesOnly yes` prevents `ssh` from offering other keys to that host.
- `IdentityAgent` ensures the correct agent socket is used even if `SSH_AUTH_SOCK` points elsewhere.
- `IdentityFile` points to a `.pub` file — `ssh` reads it to identify which key to request from the agent; the private key never leaves the agent.

### Conflict resolution

If multiple vault items claim the same `ssh_host` pattern, the item with the **most recent `revision_date`** wins.  Older items have that specific `Host` block omitted from their snippet.  If an item loses all its host entries to newer items, its `.conf` file still exists but contains only a header comment explaining the conflict.

This ensures generated configs are deterministic and consistent across vault re-syncs.

### Activating the generated configs

Add one line to `~/.ssh/config` (replace `1000` with your actual UID, or use the resolved path):

```
Include /run/user/1000/rosec/ssh/config.d/*
```

Because the `config.d/` directory lives on the FUSE mount, the snippets are always up-to-date — there is nothing to regenerate manually.  You can also copy individual `.conf` files to a static location if you prefer.

### Wildcard patterns in filenames

OpenSSH `Host` patterns use `*` and `?` as wildcards.  Since `*` is illegal in FUSE filenames (it would trigger shell glob expansion), the `by-host/` directory substitutes `*` with `_star` and `?` with `_qmark`:

| Host pattern | Filename in `by-host/` |
|---|---|
| `github.com` | `github.com.pub` |
| `*.prod.example.com` | `_star.prod.example.com.pub` |
| `192.168.?.1` | `192.168._qmark.1.pub` |

The `config.d/` snippets use the original pattern in the `Host` line — the substitution only applies to FUSE filenames.

## Using the SSH Agent

### As the default agent (environment variable)

```bash
export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/rosec/agent.sock"
```

Add this to your shell profile to make rosec the default agent for all SSH connections.

### As the default agent (SSH config)

Alternatively, you can set `IdentityAgent` globally in `~/.ssh/config` so that all connections use the rosec agent without needing the environment variable:

```
Host *
    IdentityAgent /run/user/1000/rosec/agent.sock
```

Replace `1000` with your actual UID (or use `${XDG_RUNTIME_DIR}` if your SSH client supports it).  This approach is useful when you want rosec to handle *all* SSH connections, not just those with explicit `ssh_host` mappings.

> **Note:** Place the `Host *` block **after** the `Include config.d/*` line so that per-host `IdentityFile` and `IdentitiesOnly` settings from the generated snippets take priority (SSH uses first-match-wins per parameter).

### Per-host via generated config

When you use the `Include config.d/*` approach, each generated snippet sets `IdentityAgent` explicitly, so neither `SSH_AUTH_SOCK` nor a `Host *` block is needed for those hosts.

### Checking loaded keys

```bash
SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/rosec/agent.sock" ssh-add -l
```

### Signing confirmation

By default, signing operations are silent (like standard `ssh-agent`).  To require interactive confirmation before a key is used for signing, add a text custom field to the vault item:

| Field name | Field value |
|---|---|
| `ssh_confirm` (or `ssh-confirm`) | `true` |

When this field is present, rosec will prompt for confirmation each time a signing request arrives for that key.

## Multi-Backend Support

The SSH agent is backend-agnostic.  Any `VaultBackend` implementation that returns vault items with discoverable SSH key material (native SSH key type, or PEM content in notes/fields) will have those keys automatically included.

This means SSH keys from Bitwarden PM, Bitwarden SM, 1Password (future), Proton Pass (future), or any other backend are all surfaced through the same agent socket and FUSE filesystem without backend-specific configuration.

## Security Notes

- **Private keys are never written to disk.**  The FUSE filesystem exposes only public keys (`.pub` files).  Private key material lives exclusively in the agent's in-memory key store, which is zeroized on lock or process exit.
- **The agent socket is owned by your user** and has mode `0600`.  No other user can connect to it.
- **Locking the backend locks the agent.**  When a backend is locked (e.g. due to the autolock timer or `rosec backend lock`), its keys are immediately removed from the agent and from the FUSE filesystem.
- **Encrypted PEM keys** (`BEGIN ENCRYPTED PRIVATE KEY`) are supported; the passphrase is prompted interactively the first time the key is loaded.

## Troubleshooting

### Keys not appearing

1. Check that the backend is unlocked: `rosec backend list`
2. Check that the FUSE mount is active: `ls "$XDG_RUNTIME_DIR/rosec/ssh/keys/by-name/"`
3. For PEM keys, verify the PEM header is one of the recognised formats listed above

### `config.d/` snippet not generated

The snippet is only generated for items that have at least one `ssh_host` (or `ssh-host`) custom field.  The field must be a **text** type (not hidden).  Verify the field name is exactly `ssh_host` or `ssh-host` (case-sensitive — `SSH_Host` will not work).

### Multiple items claiming the same host

Run `rosec ssh list` to see which item currently owns each host pattern and when each item was last updated.  The most recently updated item wins.

### FUSE mount fails

Ensure `fusermount3` is installed and that your user is in the `fuse` group (or that `/etc/fuse.conf` contains `user_allow_other`).

```bash
# Debian/Ubuntu
sudo apt install fuse3
sudo usermod -aG fuse "$USER"
```
